<!doctype html>
<html lang="pt-BR" class="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Luna – Supervisor WhatsApp</title>

  <link rel="stylesheet" href="styles.css"/>
  <style>
    .hidden{display:none!important}

    /* Garantia: quando estiver em Pagamentos, mostra o billing e esconde chat */
    .mode-billing #billing-view{ display:block !important; }
    .mode-billing .chatbar, .mode-billing #messages{ display:none !important; }

    /* No mobile, Pagamentos ocupa a tela toda (sem sidebar) */
    @media (max-width:1023px){
      .nav-rail{ display:none; }
      .mode-billing .sidebar{ display:none !important; }
      .mode-billing .main{ width:100% !important; max-width:100% !important; flex:1 1 auto; }
      .mode-billing .shell{ grid-template-columns: 1fr !important; }

      /* Navegação mobile (tabs) */
      .mobile-nav{
        position: sticky; top: 0; z-index: 30;
        display:flex; gap:8px; padding:8px 12px;
        background: var(--bg, #0b0f15);
        border-bottom: 1px solid var(--border, #1f2633);
      }
      .mobile-nav .menu-item{
        flex:1; display:inline-flex; align-items:center; justify-content:center; gap:8px;
        padding:10px 12px; border-radius:10px; cursor:pointer;
        background: var(--bg2, #121826);
        border: 1px solid var(--border, #222a3a);
        color: var(--text, #e7eaf1);
      }
      .mobile-nav .menu-item.active{
        border-color: var(--accent,#6C5CE7);
        box-shadow: inset 0 0 0 1px var(--accent,#6C5CE7);
      }
      .mobile-nav .menu-item svg{ pointer-events:none }
    }
    @media (min-width:1024px){ .mobile-nav{ display:none } }
  </style>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;600;700&family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Scripts -->
  <script defer src="config.js"></script>
  <script defer src="app.js"></script>
</head>
<body class="mode-chat">

  <!-- LOGIN -->
  <main id="login-view" class="login hidden">
    <!-- Etapa 1: Login da conta -->
    <div id="step-account" class="login-step">
      <div class="login-card">
        <div class="login-header">
          <div class="login-logo"><img src="lunapngcinza.png" alt="Luna" class="loading-logo"></div>
          <h1>Luna</h1>
          <p class="login-sub">Entre com sua conta para continuar</p>
        </div>
        <div class="login-form">
          <div class="form-group">
            <label for="acct-email">E-mail</label>
            <input id="acct-email" type="email" class="inp" placeholder="Seu e‑mail" autocomplete="username" />
          </div>
          <div class="form-group">
            <label for="acct-pass">Senha</label>
            <input id="acct-pass" type="password" class="inp" placeholder="Sua senha" autocomplete="current-password" />
          </div>
          <div id="acct-msg" class="msg-err"></div>
          <button id="btn-acct-login" class="btn btn-primary">Entrar</button>
          <div class="login-register-container">
            <span>Não tem conta?</span>
            <a href="#" id="link-acct-register">Criar conta</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Etapa 1b: Registro -->
    <div id="step-register" class="login-step hidden">
      <div class="login-card">
        <div class="login-header">
          <div class="login-logo"><img src="lunapngcinza.png" alt="Luna" class="loading-logo"></div>
          <h1>Criar Conta</h1>
          <p class="login-sub">Preencha os campos para criar sua conta</p>
        </div>
        <div class="login-form">
          <div class="form-group">
            <label for="reg-email">E-mail</label>
            <input id="reg-email" type="email" class="inp" placeholder="Seu e‑mail" autocomplete="username" />
          </div>
          <div class="form-group">
            <label for="reg-pass">Senha</label>
            <input id="reg-pass" type="password" class="inp" placeholder="Crie uma senha" autocomplete="new-password" />
          </div>
          <div id="reg-msg" class="msg-err"></div>
          <button id="btn-acct-register" class="btn btn-primary">Criar Conta</button>
          <button id="btn-back-to-login" class="btn btn-secondary">Voltar</button>
        </div>
      </div>
    </div>

    <!-- Etapa 2: Conexão da instância -->
    <div id="step-instance" class="login-step hidden">
      <div class="login-card">
        <div class="login-header">
          <div class="login-logo"><img src="lunapngcinza.png" alt="Luna" class="loading-logo"></div>
          <h1>Luna</h1>
          <p class="login-sub">Conecte sua instância do WhatsApp</p>
        </div>
        <div class="login-form">
          <div class="form-group">
            <label for="token">Token da instância</label>
            <input id="token" type="text" class="inp" placeholder="Cole o token aqui" />
          </div>
          <div id="msg" class="msg-err"></div>
          <button id="btn-login" class="btn btn-primary">
            <span>Conectar instância</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- LOADING -->
  <section id="loading-view" class="loading hidden">
    <div class="loading-container">
      <div class="loading-logos-animation">
        <div class="loading-logo-luna"><img src="lunapngcinza.png" alt="Luna" class="loading-logo"></div>
        <div class="loading-logo-helsenia"><img src="logohelsenia.png" alt="Helsenia" class="loading-logo" onerror="this.src='lunapngcinza.png'"></div>
      </div>
      <h2>Carregando Sistema</h2>
      <p>Preparando suas conversas...</p>
      <div class="loading-progress"><div class="progress-bar"><div class="progress-fill"></div></div></div>
    </div>
  </section>

  <!-- APP -->
  <section id="app-view" class="app">
    <header class="topbar">
      <div class="brand">
        <div class="brand-icon"><img src="lunapngcinza.png" alt="Luna" class="brand-logo"></div>
        <div class="brand-text"><span class="brand-name">Luna</span><small id="profile">Supervisor WhatsApp</small></div>
      </div>
      <div class="topbar-actions">
        <button id="btn-refresh" class="btn btn-icon" title="Atualizar" aria-label="Atualizar">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12a9 9 0 0 1 9-9 9.8 9.8 0 0 1 6.7 2.7L21 8"/><path d="M21 3v5h-5"/>
            <path d="M21 12a9 9 0 0 1-9 9 9.8 9.8 0 0 1-6.7-2.7L3 16"/><path d="M3 21v-5h5"/>
          </svg>
        </button>
        <button id="btn-logout" class="btn btn-secondary">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
          <span class="btn-text">Sair</span>
        </button>
      </div>
    </header>

    <!-- MENU MOBILE (tabs) -->
    <div class="mobile-nav">
      <button id="btn-mobile-conversas" class="menu-item active" data-view="conversas" aria-label="Conversas">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        <span class="label">Conversas</span>
      </button>
      <button id="btn-mobile-pagamentos" class="menu-item" data-view="pagamentos" aria-label="Pagamentos">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/>
        </svg>
        <span class="label">Pagamentos</span>
      </button>
    </div>

    <div class="shell">
      <!-- MENU LATERAL (desktop) -->
      <nav class="nav-rail" aria-label="Menu principal">
        <button id="btn-rail-toggle" class="rail-toggle" aria-label="Recolher/Expandir menu">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
          <span class="label">Recolher</span>
        </button>

        <div class="menu-title">Menu</div>

        <button id="btn-conversas" class="menu-item active" data-view="conversas">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          <span class="label">Conversas</span>
        </button>

        <button id="btn-pagamentos" class="menu-item" data-view="pagamentos">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/>
          </svg>
          <span class="label">Pagamentos</span>
        </button>
      </nav>

      <!-- LISTA DE CONVERSAS -->
      <aside class="sidebar">
        <div class="sidebar-head">
          <h2>Conversas</h2>
          <div class="mobile-stage-selector">
            <select id="mobile-stage-select" class="stage-select">
              <option value="geral">Geral</option>
              <option value="contatos">Contatos</option>
              <option value="lead">Lead</option>
              <option value="lead_quente">Lead Quente</option>
            </select>
          </div>
          <div class="mobile-counters">
            <span>Contatos: <b id="mobile-counter-contatos">0</b></span>
            <span>Lead: <b id="mobile-counter-lead">0</b></span>
            <span>Lead Quente: <b id="mobile-counter-lead_quente">0</b></span>
          </div>
          <div class="sidebar-stats"><span class="stats-badge">Ativo</span></div>
        </div>
        <div id="chat-list" class="chat-list"></div>
      </aside>

      <!-- CONTEÚDO PRINCIPAL -->
      <main class="main">
        <!-- Pagamentos -->
        <div id="billing-view" class="billing-view hidden" tabindex="-1">
          <div class="billing-header">
            <h2>Pagamentos</h2>
            <p>Gerencie sua assinatura da Luna AI</p>
          </div>
          <div class="billing-content">
            <div class="billing-plan">
              <div class="plan-header">
                <h3>Luna AI Professional</h3>
                <div class="plan-price">R$ 349,90<span>/mês</span></div>
              </div>
              <div class="plan-description">
                <p>Prospecção inteligente por nicho específico, muito mais eficaz que campanhas aleatórias. Supervisione conversas do WhatsApp com IA avançada.</p>
              </div>
            </div>

            <div class="billing-status">
              <h4>Seu Status</h4>
              <div id="billing-status-content" class="status-content">
                <div class="status-item"><span class="status-label">Plano atual:</span><span id="current-plan" class="status-value">Trial</span></div>
                <div class="status-item"><span class="status-label">Dias restantes:</span><span id="days-remaining" class="status-value">0</span></div>
                <div class="status-item"><span class="status-label">Trial até:</span><span id="trial-until" class="status-value">N/A</span></div>
                <div class="status-item"><span class="status-label">Pago até:</span><span id="paid-until" class="status-value">N/A</span></div>
              </div>
            </div>

            <div class="billing-features">
              <h4>Benefícios Inclusos</h4>
              <ul>
                <li><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>Acesso ilimitado às conversas do WhatsApp com IA</li>
                <li><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>Prospecção segmentada por nicho</li>
                <li><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>Suporte prioritário via chat</li>
                <li><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>Acesso a novos recursos em primeira mão</li>
              </ul>
            </div>

            <div class="billing-actions">
              <button id="btn-pay-getnet" class="btn btn-primary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/>
                </svg>
                Assinar agora
              </button>
            </div>
          </div>
        </div>

        <!-- Chat -->
        <div class="chatbar">
          <button id="btn-back-mobile" class="btn btn-icon back" title="Voltar" aria-label="Voltar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
          </button>
          <div class="chat-info">
            <div id="chat-header" class="chat-title">Selecione uma conversa</div>
            <div class="chat-status">Escolha um chat para começar</div>
          </div>
        </div>

        <div id="messages" class="messages">
          <div class="empty-state">
            <div class="empty-icon">💬</div>
            <h3>Nenhuma conversa selecionada</h3>
            <p>Escolha uma conversa da lista para visualizar as mensagens</p>
          </div>
        </div>
      </main>
    </div>
  </section>

  <!-- MODAL TRIAL -->
  <div id="billing-modal" class="billing-modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content">
      <div class="modal-header"><h3>Período de teste expirado</h3></div>
      <div class="modal-body"><p>Seu período de teste grátis acabou. Vá em Pagamentos para continuar usando a Luna AI.</p></div>
      <div class="modal-actions">
        <button id="btn-go-to-payments" class="btn btn-primary">Ir para Pagamentos</button>
        <button id="btn-logout-modal" class="btn btn-secondary">Sair</button>
      </div>
    </div>
  </div>

  <!-- MODAL DE PAGAMENTO COM CARTÃO -->
  <div id="card-modal" class="payment-modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content">
      <div class="modal-header"><h3>Dados do pagamento</h3></div>
      <form id="card-form" class="modal-body">
        <div class="form-group">
          <label for="card-name">Nome completo</label>
          <input id="card-name" type="text" class="inp" placeholder="Nome do cliente" required />
        </div>
        <div class="form-group">
          <label for="card-email">E‑mail</label>
          <input id="card-email" type="email" class="inp" placeholder="email@exemplo.com" required />
        </div>
        <div class="form-group">
          <label for="card-document">CPF/CNPJ</label>
          <input id="card-document" type="text" class="inp" placeholder="Documento" />
        </div>
        <div class="form-group">
          <label for="card-phone">Telefone</label>
          <input id="card-phone" type="text" class="inp" placeholder="DDD + número" />
        </div>

        <div class="form-spacer"></div>
        <h4>Dados do cartão</h4>

        <div class="form-group">
          <label for="cardholder-name">Nome no cartão</label>
          <input id="cardholder-name" type="text" class="inp" placeholder="Como impresso no cartão" required />
        </div>
        <div class="form-group">
          <label for="card-number">Número do cartão</label>
          <input id="card-number" type="text" class="inp" inputmode="numeric" maxlength="19" placeholder="0000 0000 0000 0000" required />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="card-exp-month">Mês</label>
            <input id="card-exp-month" type="text" class="inp" inputmode="numeric" maxlength="2" placeholder="MM" required />
          </div>
          <div class="form-group">
            <label for="card-exp-year">Ano</label>
            <input id="card-exp-year" type="text" class="inp" inputmode="numeric" maxlength="4" placeholder="AAAA" required />
          </div>
          <div class="form-group">
            <label for="card-cvv">CVV</label>
            <input id="card-cvv" type="text" class="inp" inputmode="numeric" maxlength="4" placeholder="Cód." required />
          </div>
        </div>
        <div class="form-group">
          <label for="card-brand">Bandeira</label>
          <select id="card-brand" class="inp" required>
            <option value="">Selecione</option>
            <option value="Mastercard">Mastercard</option>
            <option value="Visa">Visa</option>
            <option value="American Express">American Express</option>
            <option value="Elo">Elo</option>
            <option value="Hipercard">Hipercard</option>
            <option value="Diners">Diners</option>
          </select>
        </div>
        <div class="form-group">
          <label for="card-type">Tipo</label>
          <select id="card-type" class="inp" required>
            <option value="credit">Crédito</option>
            <option value="debit">Débito</option>
          </select>
        </div>

        <details class="billing-address">
          <summary>Endereço de cobrança (opcional)</summary>
          <div class="form-row">
            <div class="form-group">
              <label for="bill-street">Rua</label>
              <input id="bill-street" type="text" class="inp" placeholder="Rua/Avenida" />
            </div>
            <div class="form-group">
              <label for="bill-number">Número</label>
              <input id="bill-number" type="text" class="inp" placeholder="Nº" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="bill-complement">Complemento</label>
              <input id="bill-complement" type="text" class="inp" placeholder="Apto, sala..." />
            </div>
            <div class="form-group">
              <label for="bill-district">Bairro</label>
              <input id="bill-district" type="text" class="inp" placeholder="Bairro" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="bill-city">Cidade</label>
              <input id="bill-city" type="text" class="inp" placeholder="Cidade" />
            </div>
            <div class="form-group">
              <label for="bill-state">Estado</label>
              <input id="bill-state" type="text" class="inp" placeholder="UF" maxlength="2" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="bill-country">País</label>
              <input id="bill-country" type="text" class="inp" placeholder="Brasil" value="Brasil" />
            </div>
            <div class="form-group">
              <label for="bill-postal">CEP</label>
              <input id="bill-postal" type="text" class="inp" placeholder="CEP" />
            </div>
          </div>
        </details>

        <div id="card-error" class="msg-err"></div>
        <div class="modal-actions">
          <button type="button" id="btn-card-cancel" class="btn btn-secondary">Cancelar</button>
          <button type="submit" id="btn-card-submit" class="btn btn-primary">Pagar</button>
        </div>
      </form>
    </div>
  </div>

  <noscript><div style="padding:16px;background:#111;color:#fff">Ative o JavaScript para usar a Luna.</div></noscript>

  <!-- JS de UI: ponte com app.js + troca das classes do body -->
  <script>
  (function () {
    const body = document.body;

    // Desktop
    const btnConversas = document.getElementById('btn-conversas');
    const btnPagamentos = document.getElementById('btn-pagamentos');

    // Mobile
    const btnMobileConversas = document.getElementById('btn-mobile-conversas');
    const btnMobilePagamentos = document.getElementById('btn-mobile-pagamentos');

    // Modal / ações
    const btnGoToPayments = document.getElementById('btn-go-to-payments');
    const btnPayGetnet = document.getElementById('btn-pay-getnet');

    const elBilling = document.getElementById('billing-view');
    const elChatbar = document.querySelector('.chatbar');
    const elMessages = document.getElementById('messages');
    const elSidebar  = document.querySelector('.sidebar');

    const show = (el)=>{ if(el) el.classList.remove('hidden'); };
    const hide = (el)=>{ if(el) el.classList.add('hidden'); };

    function selectMenu(view){
      document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active'));
      if (view==='billing') {
        document.getElementById('btn-pagamentos')?.classList.add('active');
        btnMobileConversas?.classList.remove('active');
        btnMobilePagamentos?.classList.add('active');
      } else {
        document.getElementById('btn-conversas')?.classList.add('active');
        btnMobileConversas?.classList.add('active');
        btnMobilePagamentos?.classList.remove('active');
      }
    }

    function goConversas(e){
      if (e) e.preventDefault();
      body.classList.add('mode-chat'); body.classList.remove('mode-billing');
      hide(elBilling); show(elChatbar); show(elMessages); show(elSidebar);
      try { window.showConversasView?.(); } catch {}
      try { window.setViewInURL?.('conversas', true); } catch {}
      selectMenu('chat');
    }

    function goBilling(e){
      if (e) e.preventDefault();
      body.classList.add('mode-billing'); body.classList.remove('mode-chat');
      show(elBilling); hide(elChatbar); hide(elMessages); hide(elSidebar); // <- mobile: sem sidebar
      try { window.showBillingView?.(); } catch {}
      try { window.setViewInURL?.('billing'); } catch {}
      selectMenu('billing');
      elBilling?.focus();
    }

    // Bindings
    btnConversas?.addEventListener('click', goConversas);
    btnPagamentos?.addEventListener('click', goBilling);
    btnMobileConversas?.addEventListener('click', goConversas);
    btnMobilePagamentos?.addEventListener('click', goBilling);

    btnPayGetnet?.addEventListener('click', (e)=>{e.preventDefault(); try{window.showCardModal?.();}catch{}});
    btnGoToPayments?.addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById('billing-modal')?.classList.add('hidden'); goBilling(); });

    // Deep-link (#billing ou ?view=billing)
    function syncFromURL() {
      const url = new URL(window.location.href);
      const view = (url.searchParams.get('view') || url.hash.replace(/^#/, '') || '').toLowerCase();
      if (view === 'billing' || view === 'pagamentos') goBilling();
      else goConversas();
    }
    window.addEventListener('hashchange', syncFromURL);
    window.addEventListener('popstate', syncFromURL);
    // Primeira renderização
    syncFromURL();
  })();
  </script>

  <!-- Integração com GetNet é feita no app.js -->
</body>
</html>
