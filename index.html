<!doctype html>
<html lang="pt-BR" class="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Luna ‚Äì Supervisor WhatsApp</title>

  <link rel="stylesheet" href="styles.css"/>
  <style>.hidden{display:none!important}</style>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;600;700&family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Scripts -->
  <script defer src="config.js"></script>
  <script defer src="app.js"></script>
</head>
<body class="mode-chat">

  <!-- LOGIN -->
  <main id="login-view" class="login hidden">
    <!-- Etapa 1: Login da conta -->
    <div id="step-account" class="login-step">
      <div class="login-card">
        <div class="login-header">
          <div class="login-logo"><img src="lunapngcinza.png" alt="Luna" class="loading-logo"></div>
          <h1>Luna</h1>
          <p class="login-sub">Entre com sua conta para continuar</p>
        </div>
        <div class="login-form">
          <div class="form-group">
            <label for="acct-email">E-mail</label>
            <input id="acct-email" type="email" class="inp" placeholder="Seu e‚Äëmail" autocomplete="username" />
          </div>
          <div class="form-group">
            <label for="acct-pass">Senha</label>
            <input id="acct-pass" type="password" class="inp" placeholder="Sua senha" autocomplete="current-password" />
          </div>
          <div id="acct-msg" class="msg-err"></div>
          <button id="btn-acct-login" class="btn btn-primary">Entrar</button>
          <div class="login-register-container">
            <span>N√£o tem conta?</span>
            <a href="#" id="link-acct-register">Criar conta</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Etapa 1b: Registro -->
    <div id="step-register" class="login-step hidden">
      <div class="login-card">
        <div class="login-header">
          <div class="login-logo"><img src="lunapngcinza.png" alt="Luna" class="loading-logo"></div>
          <h1>Criar Conta</h1>
          <p class="login-sub">Preencha os campos para criar sua conta</p>
        </div>
        <div class="login-form">
          <div class="form-group">
            <label for="reg-email">E-mail</label>
            <input id="reg-email" type="email" class="inp" placeholder="Seu e‚Äëmail" autocomplete="username" />
          </div>
          <div class="form-group">
            <label for="reg-pass">Senha</label>
            <input id="reg-pass" type="password" class="inp" placeholder="Crie uma senha" autocomplete="new-password" />
          </div>
          <div id="reg-msg" class="msg-err"></div>
          <button id="btn-acct-register" class="btn btn-primary">Criar Conta</button>
          <button id="btn-back-to-login" class="btn btn-secondary">Voltar</button>
        </div>
      </div>
    </div>

    <!-- Etapa 2: Conex√£o da inst√¢ncia -->
    <div id="step-instance" class="login-step hidden">
      <div class="login-card">
        <div class="login-header">
          <div class="login-logo"><img src="lunapngcinza.png" alt="Luna" class="loading-logo"></div>
          <h1>Luna</h1>
          <p class="login-sub">Conecte sua inst√¢ncia do WhatsApp</p>
        </div>
        <div class="login-form">
          <div class="form-group">
            <label for="token">Token da inst√¢ncia</label>
            <input id="token" type="text" class="inp" placeholder="Cole o token aqui" />
          </div>
          <div id="msg" class="msg-err"></div>
          <button id="btn-login" class="btn btn-primary">
            <span>Conectar inst√¢ncia</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- LOADING -->
  <section id="loading-view" class="loading hidden">
    <div class="loading-container">
      <div class="loading-logos-animation">
        <div class="loading-logo-luna"><img src="lunapngcinza.png" alt="Luna" class="loading-logo"></div>
        <div class="loading-logo-helsenia"><img src="logohelsenia.png" alt="Helsenia" class="loading-logo" onerror="this.src='lunapngcinza.png'"></div>
      </div>
      <h2>Carregando Sistema</h2>
      <p>Preparando suas conversas...</p>
      <div class="loading-progress"><div class="progress-bar"><div class="progress-fill"></div></div></div>
    </div>
  </section>

  <!-- APP -->
  <section id="app-view" class="app">
    <header class="topbar">
      <div class="brand">
        <div class="brand-icon"><img src="lunapngcinza.png" alt="Luna" class="brand-logo"></div>
        <div class="brand-text"><span class="brand-name">Luna</span><small id="profile">Supervisor WhatsApp</small></div>
      </div>
      <div class="topbar-actions">
        <button id="btn-refresh" class="btn btn-icon" title="Atualizar" aria-label="Atualizar">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12a9 9 0 0 1 9-9 9.8 9.8 0 0 1 6.7 2.7L21 8"/><path d="M21 3v5h-5"/>
            <path d="M21 12a9 9 0 0 1-9 9 9.8 9.8 0 0 1-6.7-2.7L3 16"/><path d="M3 21v-5h5"/>
          </svg>
        </button>
        <button id="btn-logout" class="btn btn-secondary">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
          <span class="btn-text">Sair</span>
        </button>
      </div>
    </header>

    <div class="shell">
      <!-- MENU LATERAL -->
      <nav class="nav-rail" aria-label="Menu principal">
        <button id="btn-rail-toggle" class="rail-toggle" aria-label="Recolher/Expandir menu">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
          <span class="label">Recolher</span>
        </button>

        <div class="menu-title">Menu</div>

        <button id="btn-conversas" class="menu-item active" data-view="conversas">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          <span class="label">Conversas</span>
        </button>

        <button id="btn-pagamentos" class="menu-item" data-view="pagamentos">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/>
          </svg>
          <span class="label">Pagamentos</span>
        </button>
      </nav>

      <!-- LISTA DE CONVERSAS -->
      <aside class="sidebar">
        <div class="sidebar-head">
          <h2>Conversas</h2>
          <div class="mobile-stage-selector">
            <select id="mobile-stage-select" class="stage-select">
              <option value="geral">Geral</option>
              <option value="contatos">Contatos</option>
              <option value="lead">Lead</option>
              <option value="lead_quente">Lead Quente</option>
            </select>
          </div>
          <div class="mobile-counters">
            <span>Contatos: <b id="mobile-counter-contatos">0</b></span>
            <span>Lead: <b id="mobile-counter-lead">0</b></span>
            <span>Lead Quente: <b id="mobile-counter-lead_quente">0</b></span>
          </div>
          <div class="sidebar-stats"><span class="stats-badge">Ativo</span></div>
        </div>
        <div id="chat-list" class="chat-list"></div>
      </aside>

      <!-- CONTE√öDO PRINCIPAL -->
      <main class="main">
        <!-- Pagamentos -->
        <div id="billing-view" class="billing-view hidden" tabindex="-1">
          <div class="billing-header">
            <h2>Pagamentos</h2>
            <p>Gerencie sua assinatura da Luna AI</p>
          </div>
          <div class="billing-content">
            <div class="billing-plan">
              <div class="plan-header">
                <h3>Luna AI Professional</h3>
                <div class="plan-price">R$ 349,90<span>/m√™s</span></div>
              </div>
              <div class="plan-description">
                <p>Prospec√ß√£o inteligente por nicho espec√≠fico, muito mais eficaz que campanhas aleat√≥rias. Supervisione conversas do WhatsApp com IA avan√ßada.</p>
              </div>
            </div>

            <div class="billing-status">
              <h4>Seu Status</h4>
              <div id="billing-status-content" class="status-content">
                <div class="status-item"><span class="status-label">Plano atual:</span><span id="current-plan" class="status-value">Trial</span></div>
                <div class="status-item"><span class="status-label">Dias restantes:</span><span id="days-remaining" class="status-value">0</span></div>
                <div class="status-item"><span class="status-label">Trial at√©:</span><span id="trial-until" class="status-value">N/A</span></div>
                <div class="status-item"><span class="status-label">Pago at√©:</span><span id="paid-until" class="status-value">N/A</span></div>
              </div>
            </div>

            <div class="billing-features">
              <h4>Benef√≠cios Inclusos</h4>
              <ul>
                <li><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>Acesso ilimitado √†s conversas do WhatsApp com IA</li>
                <li><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>Prospec√ß√£o segmentada por nicho</li>
                <li><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>Suporte priorit√°rio via chat</li>
                <li><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>Acesso a novos recursos em primeira m√£o</li>
              </ul>
            </div>

            <div class="billing-actions">
              <button id="btn-pay-getnet" class="btn btn-primary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/>
                </svg>
                Assinar agora
              </button>
            </div>
          </div>
        </div>

        <!-- Chat -->
        <div class="chatbar">
          <button id="btn-back-mobile" class="btn btn-icon back" title="Voltar" aria-label="Voltar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
          </button>
          <div class="chat-info">
            <div id="chat-header" class="chat-title">Selecione uma conversa</div>
            <div class="chat-status">Escolha um chat para come√ßar</div>
          </div>
        </div>

        <div id="messages" class="messages">
          <div class="empty-state">
            <div class="empty-icon">üí¨</div>
            <h3>Nenhuma conversa selecionada</h3>
            <p>Escolha uma conversa da lista para visualizar as mensagens</p>
          </div>
        </div>
      </main>
    </div>
  </section>

  <!-- MODAL TRIAL -->
  <div id="billing-modal" class="billing-modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content">
      <div class="modal-header"><h3>Per√≠odo de teste expirado</h3></div>
      <div class="modal-body"><p>Seu per√≠odo de teste gr√°tis acabou. V√° em Pagamentos para continuar usando a Luna AI.</p></div>
      <div class="modal-actions">
        <button id="btn-go-to-payments" class="btn btn-primary">Ir para Pagamentos</button>
        <button id="btn-logout-modal" class="btn btn-secondary">Sair</button>
      </div>
    </div>
  </div>

  <!-- MODAL DE PAGAMENTO COM CART√ÉO -->
  <div id="card-modal" class="payment-modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content">
      <div class="modal-header"><h3>Dados do pagamento</h3></div>
      <form id="card-form" class="modal-body">
        <div class="form-group">
          <label for="card-name">Nome completo</label>
          <input id="card-name" type="text" class="inp" placeholder="Nome do cliente" required />
        </div>
        <div class="form-group">
          <label for="card-email">E‚Äëmail</label>
          <input id="card-email" type="email" class="inp" placeholder="email@exemplo.com" required />
        </div>
        <div class="form-group">
          <label for="card-document">CPF/CNPJ</label>
          <input id="card-document" type="text" class="inp" placeholder="Documento" />
        </div>
        <div class="form-group">
          <label for="card-phone">Telefone</label>
          <input id="card-phone" type="text" class="inp" placeholder="DDD + n√∫mero" />
        </div>

        <div class="form-spacer"></div>
        <h4>Dados do cart√£o</h4>

        <div class="form-group">
          <label for="cardholder-name">Nome no cart√£o</label>
          <input id="cardholder-name" type="text" class="inp" placeholder="Como impresso no cart√£o" required />
        </div>
        <div class="form-group">
          <label for="card-number">N√∫mero do cart√£o</label>
          <input id="card-number" type="text" class="inp" inputmode="numeric" maxlength="19" placeholder="0000 0000 0000 0000" required />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="card-exp-month">M√™s</label>
            <input id="card-exp-month" type="text" class="inp" inputmode="numeric" maxlength="2" placeholder="MM" required />
          </div>
          <div class="form-group">
            <label for="card-exp-year">Ano</label>
            <input id="card-exp-year" type="text" class="inp" inputmode="numeric" maxlength="4" placeholder="AAAA" required />
          </div>
          <div class="form-group">
            <label for="card-cvv">CVV</label>
            <input id="card-cvv" type="text" class="inp" inputmode="numeric" maxlength="4" placeholder="C√≥d." required />
          </div>
        </div>
        <div class="form-group">
          <label for="card-brand">Bandeira</label>
          <select id="card-brand" class="inp" required>
            <option value="">Selecione</option>
            <option value="Mastercard">Mastercard</option>
            <option value="Visa">Visa</option>
            <option value="American Express">American Express</option>
            <option value="Elo">Elo</option>
            <option value="Hipercard">Hipercard</option>
            <option value="Diners">Diners</option>
          </select>
        </div>
        <div class="form-group">
          <label for="card-type">Tipo</label>
          <select id="card-type" class="inp" required>
            <option value="credit">Cr√©dito</option>
            <option value="debit">D√©bito</option>
          </select>
        </div>

        <details class="billing-address">
          <summary>Endere√ßo de cobran√ßa (opcional)</summary>
          <div class="form-row">
            <div class="form-group">
              <label for="bill-street">Rua</label>
              <input id="bill-street" type="text" class="inp" placeholder="Rua/Avenida" />
            </div>
            <div class="form-group">
              <label for="bill-number">N√∫mero</label>
              <input id="bill-number" type="text" class="inp" placeholder="N¬∫" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="bill-complement">Complemento</label>
              <input id="bill-complement" type="text" class="inp" placeholder="Apto, sala..." />
            </div>
            <div class="form-group">
              <label for="bill-district">Bairro</label>
              <input id="bill-district" type="text" class="inp" placeholder="Bairro" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="bill-city">Cidade</label>
              <input id="bill-city" type="text" class="inp" placeholder="Cidade" />
            </div>
            <div class="form-group">
              <label for="bill-state">Estado</label>
              <input id="bill-state" type="text" class="inp" placeholder="UF" maxlength="2" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="bill-country">Pa√≠s</label>
              <input id="bill-country" type="text" class="inp" placeholder="Brasil" value="Brasil" />
            </div>
            <div class="form-group">
              <label for="bill-postal">CEP</label>
              <input id="bill-postal" type="text" class="inp" placeholder="CEP" />
            </div>
          </div>
        </details>

        <div id="card-error" class="msg-err"></div>
        <div class="modal-actions">
          <button type="button" id="btn-card-cancel" class="btn btn-secondary">Cancelar</button>
          <button type="submit" id="btn-card-submit" class="btn btn-primary">Pagar</button>
        </div>
      </form>
    </div>
  </div>

  <noscript><div style="padding:16px;background:#111;color:#fff">Ative o JavaScript para usar a Luna.</div></noscript>

  <!-- JS de UI (rotas e layout) -->
  <script>
  (function () {
    const body = document.body;
    const railToggle = document.getElementById('btn-rail-toggle');
    const btnConversas = document.getElementById('btn-conversas');
    const btnPagamentos = document.getElementById('btn-pagamentos');
    const btnPayGetnet = document.getElementById('btn-pay-getnet');
    const billingView = document.getElementById('billing-view');

    function setMode(mode) {
      body.classList.toggle('mode-chat', mode === 'chat');
      body.classList.toggle('mode-billing', mode === 'billing');
      btnConversas.classList.toggle('active', mode === 'chat');
      btnPagamentos.classList.toggle('active', mode === 'billing');
      if (mode === 'billing') billingView?.focus();
    }

    function handleRoute(pathname) {
      const path = pathname || location.pathname;
      if (path === '/' || path === '') {
        setMode('chat');
      } else if (path === '/pagamentos' || path === '/pagamentos/getnet') {
        setMode('billing');
      } else {
        setMode('chat');
      }
    }

    function navTo(path, evt) {
      if (evt) evt.preventDefault();
      if (location.pathname !== path) history.pushState({}, '', path);
      handleRoute(path);
    }

    btnConversas?.addEventListener('click', (e) => navTo('/', e));
    btnPagamentos?.addEventListener('click', (e) => navTo('/pagamentos', e));
    btnPayGetnet?.addEventListener('click', (e) => {
      e.preventDefault();
      try { if (typeof window.showCardModal === 'function') window.showCardModal(); } catch {}
    });

    document.getElementById('btn-go-to-payments')?.addEventListener('click', () => {
      document.getElementById('billing-modal')?.classList.add('hidden');
      navTo('/pagamentos');
    });
    document.getElementById('btn-logout-modal')?.addEventListener('click', () => {
      document.getElementById('billing-modal')?.classList.add('hidden');
    });

    railToggle?.addEventListener('click', () => {
      body.classList.toggle('rail-collapsed');
      railToggle.querySelector('svg').style.transform =
        body.classList.contains('rail-collapsed') ? 'rotate(180deg)' : 'rotate(0deg)';
      railToggle.querySelector('.label').textContent =
        body.classList.contains('rail-collapsed') ? 'Expandir' : 'Recolher';
    });

    window.addEventListener('popstate', () => handleRoute());
    handleRoute();
  })();
  </script>

  <!-- PATCH: intercepta o submit do cart√£o e envia para /api/pay/getnet/pay-direct -->
  <script>
  (function () {
    // Helpers locais (n√£o dependem do app.js)
    function BACKEND(){ return (window.__BACKEND_URL__ || '').replace(/\/+$/,''); }
    function authHeaders(){
      try {
        const t = localStorage.getItem('luna_jwt') || '';
        return t ? { Authorization: 'Bearer ' + t } : {};
      } catch { return {}; }
    }
    function digitsOnly(s){ return String(s||'').replace(/\D+/g,''); }
    function pad2(v){ v=String(v||'').trim(); return (('0'+v).slice(-2)).slice(0,2) || '00'; }
    function toYYYY(v){
      const d = digitsOnly(v);
      if (d.length >= 4) return d.slice(0,4);
      if (d.length === 2) return '20'+d;
      if (d.length === 3) return '20'+d.slice(-2);
      return d || '';
    }
    function splitName(full){
      const parts = String(full||'').trim().split(/\s+/).filter(Boolean);
      if (!parts.length) return {first_name:'', last_name:''};
      const first = parts.shift(); const last = parts.length ? parts.join(' ') : first;
      return {first_name:first, last_name:last};
    }
    function normalizeBrand(sel, cardNumber){
      const m = String(sel||'').toLowerCase();
      if (m.includes('master')) return 'Mastercard';
      if (m.includes('american') || m.includes('amex')) return 'American Express';
      if (m.includes('elo')) return 'Elo';
      if (m.includes('hiper')) return 'Hipercard';
      if (m.includes('diners')) return 'Diners';
      return /^4\d{12,18}$/.test(digitsOnly(cardNumber)) ? 'Visa' : 'Visa';
    }
    function formatPhoneE164BR(p){
      if (!p) return '';
      let s = String(p).trim();
      if (s.startsWith('+')) return s.replace(/[^\d+]/g,'');
      s = digitsOnly(s);
      if (!s) return '';
      return s.startsWith('55') ? ('+'+s) : ('+55'+s);
    }
    async function postJSON(path, data){
      const res = await fetch(BACKEND()+path, {
        method:'POST',
        headers: { 'Content-Type':'application/json', ...authHeaders() },
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error(await res.text().catch(()=>`HTTP ${res.status}`));
      return res.json().catch(()=> ({}));
    }

    async function onSubmitCapture(e){
      if (!e) return;
      // Intercepta antes do handler antigo (captura)
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();

      const err = document.getElementById('card-error');
      const btn = document.getElementById('btn-card-submit');
      if (err) err.textContent = '';
      if (btn){ btn.disabled = true; btn.textContent = 'Processando...'; }

      try{
        const fullName = document.getElementById('card-name').value.trim();
        const email = document.getElementById('card-email').value.trim();
        const documentRaw = document.getElementById('card-document').value.trim();
        const phoneRaw = document.getElementById('card-phone').value.trim();

        const cardholderName = document.getElementById('cardholder-name').value.trim().toUpperCase();
        const cardNumber = document.getElementById('card-number').value;
        const expMonth = document.getElementById('card-exp-month').value;
        const expYear = document.getElementById('card-exp-year').value;
        const cvv = document.getElementById('card-cvv').value;
        const brandSel = document.getElementById('card-brand').value;
        const type = (document.getElementById('card-type').value || 'credit').toLowerCase();

        // Endere√ßo (opcional)
        const street = document.getElementById('bill-street')?.value || '';
        const number = document.getElementById('bill-number')?.value || '';
        const complement = document.getElementById('bill-complement')?.value || '';
        const district = document.getElementById('bill-district')?.value || '';
        const city = document.getElementById('bill-city')?.value || '';
        const state = document.getElementById('bill-state')?.value || '';
        const country = document.getElementById('bill-country')?.value || 'Brasil';
        const postal = document.getElementById('bill-postal')?.value || '';

        if(!fullName || !email || !cardholderName || !cardNumber || !expMonth || !expYear || !cvv || !brandSel){
          throw new Error('Preencha todos os campos obrigat√≥rios.');
        }
        const {first_name, last_name} = splitName(fullName);
        const brand = normalizeBrand(brandSel, cardNumber);

        const payload = {
          type,
          amount_cents: 34990,
          currency: 'BRL',
          number_installments: 1,
          cardholder_mobile: type === 'debit' ? formatPhoneE164BR(phoneRaw) : undefined,
          customer: {
            email,
            name: fullName,
            first_name, last_name,
            document_number: digitsOnly(documentRaw),
            phone_number: formatPhoneE164BR(phoneRaw),
            billing_address: {
              street, number, complement, district, city, state, country, postal_code: digitsOnly(postal)
            }
          },
          card: {
            card_number: digitsOnly(cardNumber),
            cardholder_name: cardholderName,
            expiration_month: pad2(expMonth),
            expiration_year: toYYYY(expYear),
            security_code: digitsOnly(cvv),
            brand
          },
          order_id: undefined,
          product_type: 'digital_content',
          sales_tax: 0
        };

        const res = await postJSON('/api/pay/getnet/pay-direct', payload);
        const status = String(res?.status||'').toLowerCase();
        const ok = ['approved','authorized','confirmed','paid','success'].some(s => status.includes(s));
        document.getElementById('card-modal')?.classList.add('hidden');
        alert(ok ? 'Pagamento aprovado!' : 'Pagamento em processamento. Aguarde a confirma√ß√£o.');
      } catch (ex){
        if (err) err.textContent = (ex && ex.message) ? ex.message : 'Erro ao processar pagamento.';
      } finally {
        if (btn){ btn.disabled = false; btn.textContent = 'Pagar'; }
      }
    }

    function bind(){
      const form = document.getElementById('card-form');
      if (!form || form.__pay_direct_bound) return;
      form.__pay_direct_bound = true;
      // CAPTURE = true para rodar antes do handler antigo e evitar "duplo envio"
      form.addEventListener('submit', onSubmitCapture, true);
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', bind);
    } else {
      bind();
    }
  })();
  </script>
</body>
</html>
