<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pagamento • Luna</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif; margin: 0; display: grid; place-items: center; height: 100vh; color: #222; }
    .box { padding: 24px; border: 1px solid #eee; border-radius: 12px; box-shadow: 0 6px 18px rgba(0, 0, 0, .06); max-width: 420px; }
    .hint { opacity: .7; font-size: 14px; margin-top: 6px; }
  </style>
</head>
<body>
  <div class="box">
    <h3>Redirecionando para o pagamento…</h3>
    <div class="hint">Aguarde alguns segundos.</div>
  </div>
  <script>
    (async function () {
      const backend = (window.__BACKEND_URL__ || "").replace(/\/+$/, "");
      try {
        // Plano e tenant_key podem vir da query string
        const urlObj = new URL(location.href);
        const plan = urlObj.searchParams.get("plan") || "luna_base";
        const tenantKey = urlObj.searchParams.get("tenant_key") || "";
        let target = `${backend}/api/pay/stripe/checkout-url?plan=${encodeURIComponent(plan)}`;
        if (tenantKey) target += `&tenant_key=${encodeURIComponent(tenantKey)}`;
        const r = await fetch(target, { credentials: "include" });
        if (!r.ok) throw new Error(await r.text());
        const data = await r.json();
        if (data && data.url) {
          location.href = data.url;
        } else {
          document.body.innerHTML = '<div class="box"><h3>Não foi possível iniciar o pagamento</h3><div class="hint">Tente novamente em instantes.</div></div>';
        }
      } catch (e) {
        document.body.innerHTML = '<div class="box"><h3>Falha ao redirecionar</h3><div class="hint">'+(e && e.message || 'Erro inesperado')+'</div></div>';
      }
    })();
  </script>
</body>
</html>
